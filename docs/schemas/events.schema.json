{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "vuhlp-events",
  "title": "Vuhlp Event Types",
  "description": "Schema for all event types emitted by the vuhlp-code daemon",
  "definitions": {
    "BaseEvent": {
      "type": "object",
      "required": ["id", "runId", "ts", "type"],
      "properties": {
        "id": { "type": "string", "format": "uuid" },
        "runId": { "type": "string", "format": "uuid" },
        "ts": { "type": "string", "format": "date-time" },
        "type": { "type": "string" }
      }
    },
    "ToolProposal": {
      "type": "object",
      "required": ["id", "name", "args", "riskLevel"],
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "args": { "type": "object" },
        "riskLevel": { "enum": ["low", "medium", "high"] }
      }
    },
    "ApprovalResolution": {
      "type": "object",
      "required": ["status"],
      "properties": {
        "status": { "enum": ["approved", "denied", "modified", "timeout"] },
        "feedback": { "type": "string" },
        "modifiedArgs": { "type": "object" }
      }
    },
    "MessageUserEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "content"],
          "properties": {
            "type": { "const": "message.user" },
            "nodeId": { "type": "string" },
            "content": { "type": "string" }
          }
        }
      ]
    },
    "MessageAssistantDeltaEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "delta"],
          "properties": {
            "type": { "const": "message.assistant.delta" },
            "nodeId": { "type": "string" },
            "delta": { "type": "string" },
            "index": { "type": "integer" }
          }
        }
      ]
    },
    "MessageAssistantFinalEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "content"],
          "properties": {
            "type": { "const": "message.assistant.final" },
            "nodeId": { "type": "string" },
            "content": { "type": "string" },
            "tokenCount": { "type": "integer" }
          }
        }
      ]
    },
    "MessageReasoningEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "content"],
          "properties": {
            "type": { "const": "message.reasoning" },
            "nodeId": { "type": "string" },
            "content": { "type": "string" }
          }
        }
      ]
    },
    "ToolProposedEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "tool"],
          "properties": {
            "type": { "const": "tool.proposed" },
            "nodeId": { "type": "string" },
            "tool": { "$ref": "#/definitions/ToolProposal" }
          }
        }
      ]
    },
    "ToolStartedEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "toolId"],
          "properties": {
            "type": { "const": "tool.started" },
            "nodeId": { "type": "string" },
            "toolId": { "type": "string" }
          }
        }
      ]
    },
    "ToolCompletedEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "toolId"],
          "properties": {
            "type": { "const": "tool.completed" },
            "nodeId": { "type": "string" },
            "toolId": { "type": "string" },
            "result": {},
            "error": {
              "type": "object",
              "properties": {
                "message": { "type": "string" },
                "stack": { "type": "string" }
              }
            },
            "durationMs": { "type": "integer" }
          }
        }
      ]
    },
    "ConsoleChunkEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "stream", "data", "timestamp"],
          "properties": {
            "type": { "const": "console.chunk" },
            "nodeId": { "type": "string" },
            "stream": { "enum": ["stdout", "stderr"] },
            "data": { "type": "string" },
            "timestamp": { "type": "string", "format": "date-time" }
          }
        }
      ]
    },
    "ApprovalRequestedEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "approvalId", "tool"],
          "properties": {
            "type": { "const": "approval.requested" },
            "nodeId": { "type": "string" },
            "approvalId": { "type": "string" },
            "tool": { "$ref": "#/definitions/ToolProposal" },
            "context": { "type": "string" },
            "timeoutMs": { "type": "integer" }
          }
        }
      ]
    },
    "ApprovalResolvedEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "approvalId", "resolution"],
          "properties": {
            "type": { "const": "approval.resolved" },
            "nodeId": { "type": "string" },
            "approvalId": { "type": "string" },
            "resolution": { "$ref": "#/definitions/ApprovalResolution" }
          }
        }
      ]
    },
    "HandoffSentEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["fromNodeId", "toNodeId", "edgeId"],
          "properties": {
            "type": { "const": "handoff.sent" },
            "fromNodeId": { "type": "string" },
            "toNodeId": { "type": "string" },
            "edgeId": { "type": "string" },
            "payload": {
              "type": "object",
              "properties": {
                "promptPreview": { "type": "string" },
                "contextSources": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            }
          }
        }
      ]
    },
    "HandoffReportedEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["fromNodeId", "toNodeId", "edgeId"],
          "properties": {
            "type": { "const": "handoff.reported" },
            "fromNodeId": { "type": "string" },
            "toNodeId": { "type": "string" },
            "edgeId": { "type": "string" },
            "payload": {
              "type": "object",
              "properties": {
                "summaryPreview": { "type": "string" },
                "artifactCount": { "type": "integer" }
              }
            }
          }
        }
      ]
    },
    "RunModeChangedEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["mode", "previousMode"],
          "properties": {
            "type": { "const": "run.mode.changed" },
            "mode": { "enum": ["AUTO", "INTERACTIVE"] },
            "previousMode": { "enum": ["AUTO", "INTERACTIVE"] },
            "reason": { "type": "string" },
            "turnsInProgress": { "type": "integer" }
          }
        }
      ]
    },
    "NodeControlChangedEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "control", "previousControl"],
          "properties": {
            "type": { "const": "node.control.changed" },
            "nodeId": { "type": "string" },
            "control": { "enum": ["AUTO", "MANUAL"] },
            "previousControl": { "enum": ["AUTO", "MANUAL"] }
          }
        }
      ]
    },
    "TurnStartedEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "turnId", "turnNumber", "isManual"],
          "properties": {
            "type": { "const": "turn.started" },
            "nodeId": { "type": "string" },
            "turnId": { "type": "string" },
            "turnNumber": { "type": "integer" },
            "isManual": { "type": "boolean" },
            "prompt": { "type": "string" }
          }
        }
      ]
    },
    "TurnCompletedEvent": {
      "allOf": [
        { "$ref": "#/definitions/BaseEvent" },
        {
          "type": "object",
          "required": ["nodeId", "turnId", "turnNumber", "isManual"],
          "properties": {
            "type": { "const": "turn.completed" },
            "nodeId": { "type": "string" },
            "turnId": { "type": "string" },
            "turnNumber": { "type": "integer" },
            "isManual": { "type": "boolean" },
            "result": {
              "type": "object",
              "properties": {
                "content": { "type": "string" },
                "tokenCount": { "type": "integer" },
                "durationMs": { "type": "integer" }
              }
            },
            "error": {
              "type": "object",
              "properties": {
                "message": { "type": "string" },
                "stack": { "type": "string" }
              }
            }
          }
        }
      ]
    }
  },
  "oneOf": [
    { "$ref": "#/definitions/MessageUserEvent" },
    { "$ref": "#/definitions/MessageAssistantDeltaEvent" },
    { "$ref": "#/definitions/MessageAssistantFinalEvent" },
    { "$ref": "#/definitions/MessageReasoningEvent" },
    { "$ref": "#/definitions/ToolProposedEvent" },
    { "$ref": "#/definitions/ToolStartedEvent" },
    { "$ref": "#/definitions/ToolCompletedEvent" },
    { "$ref": "#/definitions/ConsoleChunkEvent" },
    { "$ref": "#/definitions/ApprovalRequestedEvent" },
    { "$ref": "#/definitions/ApprovalResolvedEvent" },
    { "$ref": "#/definitions/HandoffSentEvent" },
    { "$ref": "#/definitions/HandoffReportedEvent" },
    { "$ref": "#/definitions/RunModeChangedEvent" },
    { "$ref": "#/definitions/NodeControlChangedEvent" },
    { "$ref": "#/definitions/TurnStartedEvent" },
    { "$ref": "#/definitions/TurnCompletedEvent" }
  ]
}
